image: ghcr.io/cirruslabs/flutter:3.22.2

stages:
  - test
  - build

cache:
  key:
    files:
      - Gemfile.lock
  paths:
    - vendor/bundle

before_script:
  - powershell -Command "if (!(bundle check --path vendor/bundle)) { bundle install --path vendor/bundle --jobs $(nproc) }"

test:
  stage: test
  script:
    - powershell -Command "bundle exec fastlane test"

build:
  stage: build
  only:
    - master
  script:
    - powershell -Command "flutter pub get"
    - powershell -Command "flutter gen-l10n; flutter test"
    - powershell -Command "flutter build apk --debug"
    - powershell -Command "flutter build apk --profile"
    - powershell -Command "flutter build apk --release"
  artifacts:
    paths:
      - app/build/outputs/bundle/release/app-release.aab
